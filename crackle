#!/bin/bash
PKG_PATH=${PKG_PATH:-/home/pkgs};
SCRP_DIR=$(dirname "${BASH_SOURCE[0]}")
[ "$1" = "clean" ] && {
    apt-get $1;
    find -L $PKG_PATH/bin -wholename $PKG_PATH/bin -o -type d -prune -o -type l -exec rm {} +;
    find -L $PKG_PATH/lib -wholename $PKG_PATH/lib -o -type d -prune -o -type l -exec rm {} +;
    exit 0;
}

[ "$1" = "setup" ] && {
    [ -d "$PKG_PATH" ] && { echo "crackle is already set up"; exit 0; }
    mkdir $PKG_PATH;
    mv $SCRP_DIR/cracklerc ~/.cracklerc;
    echo '. "$HOME/.cracklerc"' >> ~/.bashrc;
    source ~/.bashrc
}

[[ "$1" = "install" || "$1" = "crack" ]] && {
[[ "$1" = "crack" ]] && { op="install"; dir="packages/$2"; } || { op="$1"; dir="$PKG_PATH"; }
[ "$1" = "install" ] && {
	[ -d "$PKG_PATH" ] || { echo "$PKG_PATH does not exist, please run crackle setup first"; exit 1; }
}
apt-get clean;
apt-get $op --download-only $2;
readarray -t packages < <(ls /var/cache/apt/archives/*.deb);
for package in "${packages[@]}"
    do
        dpkg-deb -xv $package $dir;
    done;
}
