#!/bin/bash
PKG_PATH=${PKG_PATH:-/home/pkgs};
PKGS_DIR=${PKGS_DIR:-/var/log};
APTCACHE=${APTCACHE:-/apt/cache};
APTCONFIG=${APTCONFIG:-/etc/apt};
CRACKDIR=$HOME/packages/$2;
SCRP_DIR=$(dirname "${BASH_SOURCE[0]}")
APT_GET="apt-get -o Dir::Cache=$PKG_PATH$APTCACHE -o Dir::State=$PKG_PATH$APTCACHE -o Dir::Etc::SourceParts=$PKG_PATH$APTCONFIG"
APT_CACHE="apt-cache -o Dir::Cache=$PKG_PATH$APTCACHE -o Dir::State=$PKG_PATH$APTCACHE -o Dir::Etc::SourceParts=$PKG_PATH$APTCONFIG"
[ "$1" = "clean" ] && {
    $APT_GET "$1";
    find -L "$PKG_PATH"/bin -wholename "$PKG_PATH"/bin -o -type d -prune -o -type l -exec rm {} +;
    find -L "$PKG_PATH"/lib -wholename "$PKG_PATH"/lib -o -type d -prune -o -type l -exec rm {} +;
    exit 0;
}

[ "$1" = "setup" ] && {
    bashrc=$(grep crackle "$HOME"/.bashrc);
    profile=$(grep crackle "$HOME"/.profile);
    source $SCRP_DIR/triplet;
    TRIPLET=$(get_architecture);
    [[ -d "$PKG_PATH$PKGS_DIR" && -n "$bashrc" && -n "$profile" && -d "$PKG_PATH$APTCONFIG" && -f "$HOME"/.cracklerc ]] && { echo "crackle is already set up"; exit 0; }
    [[ -d "$PKG_PATH$PKGS_DIR" ]] || mkdir -p "$PKG_PATH$PKGS_DIR";
    [[ -d "$PKG_PATH$APTCACHE" ]] || mkdir -p "$PKG_PATH$APTCACHE";
    [[ -d "$PKG_PATH$APTCONFIG" ]] || mkdir -p "$PKG_PATH$APTCONFIG";
    echo "TRIPLET=$TRIPLET" > "$HOME"/.cracklerc;
    echo "PKG_PATH=$PKG_PATH" >> "$HOME"/.cracklerc;
    cat "$SCRP_DIR"/cracklerc >> "$HOME"/.cracklerc;
    [[ -z "$bashrc" ]] && cat "$SCRP_DIR"/crackle.conf >> "$HOME"/.bashrc;
    [[ -z "$profile" ]] && cat "$SCRP_DIR"/crackle.conf >> "$HOME"/.profile;
    # this just reloads bash the user doesn't have to
    # shellcheck source=/dev/null
    source "$HOME"/.bashrc
    exit 0;
}

[ "$1" = "update" ] && {
	$APT_GET "$1";
        exit 0;
}

[ "$1" = "download" ] && {
	$APT_GET "$1" "$2";
        exit 0;
}

[[ "$1" = "search" || "$1" = "show" ]] && {
	$APT_CACHE "$1" "$2";
        exit 0;
}

[[ "$1" = "install" || "$1" = "crack" ]] && {
    op="install";
    if [[ "$1" = "crack" ]]; then
	    dir="$CRACKDIR";
    else
	    dir="$PKG_PATH";
    fi
    [[ "$1" = "crack" && ! -d "$dir" ]] && mkdir "$dir";
    [ "$1" = "install" ] && {
            [ -d "$PKG_PATH" ] || { echo "$PKG_PATH does not exist, please run crackle setup first"; exit 1; }
    }
    [ -d "$dir$PKGS_DIR/$2" ] && { echo "$2" is already installed; exit 0; }
    $APT_GET "$op" --download-only "$2" || exit 1;
    readarray -t packages < <(ls "$PKG_PATH$APTCACHE"/archives/*.deb);
    for package in "${packages[@]}"
        do
            . "$SCRP_DIR/loginfo";
            log_pkg_info "$dir" "$package";
            dpkg-deb -x "$package" "$dir";
        done;
    $APT_GET clean;
    exit 0;
}
